<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>adsb2dd</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input, select {
      margin-bottom: 10px;
    }
    .custom-location-fields {
      display: none;
    }
    .calculator-form {
      max-width: 600px;
      margin: 0 auto;
    }
  </style>
</head>
<body>

<div class="container-md">
  <div class="jumbotron">
    <h1 class="display-4">adsb2dd</h1>
    <p class="lead">Convert ADS-B aircraft position data to a delay-Doppler point in a bistatic radar. Requires input of a receiver location, transmitter location, center frequency and a tar1090 server. This program exposes an API endpoint to generate delay-Doppler points for each aircraft - use the API calculator below to generate an API endpoint.</p>
  </div>

  <div class="calculator-form">
    <form id="delayDopplerForm">

      <label for="rxLocation">Receiver Location:</label>
      <select id="rxLocation" class="form-select" onchange="toggleCustomFields('rxLocation')">
        <option value="37.7749,-122.4194,100">Schulz Building, Adelaide</option>
        <option value="40.7128,-74.0060,50">Skye Lookout, Adelaide</option>
        <option value="34.0522,-118.2437,200">The Gun Emplacement, Adelaide</option>
        <option value="custom">Custom</option>
      </select>
      <div class="custom-location-fields" id="rxLocation-custom">
        <label for="rxLocationCustom">Custom Location (lat, lon, alt):</label>
        <input type="text" id="rxLocationCustom" class="form-control" placeholder="e.g. 37.1234, -121.5678, 200">
      </div>

      <label for="txLocation">Transmitter Location:</label>
      <select id="txLocation" class="form-select" onchange="toggleCustomFields('txLocation')">
        <option value="37.7749,-122.4194,100">Mount Lofty, Adelaide</option>
	<option value="-34.9248, 138.6007, 160">25 Grenfell Street, Adelaide</option>
        <option value="34.0522,-118.2437,200">Los Angeles, CA</option>
        <option value="custom">Custom</option>
      </select>
      <div class="custom-location-fields" id="txLocation-custom">
        <label for="txLocationCustom">Custom Location (lat, lon, alt):</label>
        <input type="text" id="txLocationCustom" class="form-control" placeholder="e.g. 37.1234, -121.5678, 200">
      </div>

      <label for="fc">Center Frequency (MHz):</label>
      <input type="text" id="fc" class="form-control" placeholder="e.g., 300000000" value="204.64">

      <label for="serverName">tar1090 Server URL:</label>
      <input type="text" id="serverName" class="form-control" placeholder="e.g. http://<tar1090-server>" value="http://adsb.30hours.dev">

      <button type="button" onclick="constructUrl()" class="btn btn-primary">Generate URL</button>
    </form>

    <p id="generatedUrl" class="mt-3"></p>
  </div>
</div>

<!-- Bootstrap JS and Popper.js (for Bootstrap's JavaScript components) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function toggleCustomFields(fieldName) {
    const selectedOption = document.getElementById(fieldName).value;
    const customField = document.getElementById(`${fieldName}-custom`);

    if (selectedOption === 'custom') {
      customField.style.display = 'block';
    } else {
      customField.style.display = 'none';
    }
  }

  function isNumeric(value) {
    return !isNaN(parseFloat(value)) && isFinite(value);
  }

  function validateLatLonAlt(latLonAlt, field) {
    const components = latLonAlt.split(',');

    if (components.length !== 3 || !components.every(isNumeric)) {
      alert(`Invalid ${field}. Please enter three valid numbers separated by commas.`);
      return false;
    }

    return true;
  }

  function constructUrl() {
    const rxLocation = document.getElementById('rxLocation').value;
    const rxLocationCustom = document.getElementById('rxLocationCustom').value;
    const rx = (rxLocation === 'custom' ? rxLocationCustom : rxLocation);

    const txLocation = document.getElementById('txLocation').value;
    const txLocationCustom = document.getElementById('txLocationCustom').value;
    const tx = (txLocation === 'custom' ? txLocationCustom : txLocation);

    const fc = document.getElementById('fc').value;
    const serverName = document.getElementById('serverName').value;

    // validation
    if (!rx || !tx || !fc || !serverName) {
      alert('Please fill in all fields.');
      return;
    }
    if (!validateLatLonAlt(rx, 'Receiver Location') || 
      !validateLatLonAlt(tx, 'Transmitter Location')) {
        return;
    }
    if (!isNumeric(fc)) {
      alert('Center frequency invalid');
      return;
    }

    var url = `/api/delaydoppler?rx=${rx}&tx=${tx}&fc=${fc}&server=${serverName}`;
    url = url.replace(/\s/g, '');

    document.getElementById('generatedUrl').textContent = `Generated URL: ${url}`;
  }
</script>

</body>
</html>

